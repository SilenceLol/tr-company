<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NORD WHEEL - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
        html, body {
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            padding: 0;
            margin: 0;
            border-radius: 0;
        }
        
        /* –®–ê–ü–ö–ê –° –õ–û–ì–û–¢–ò–ü–û–ú */
        header {
            background: #b5b5b5;
            padding: 10px 15px !important;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-image {
            height: 28px;
            width: auto;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: bold;
            color: white;
        }
        
        .auth-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        h1 {
            margin: 10px 0 15px 0;
            color: #2c3e50;
            text-align: center;
            font-size: 1.5em;
        }
        
        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        /* QR-–°–ö–ê–ù–ï–† –°–¢–ò–õ–ò */
        .qr-scanner-section {
            margin-bottom: 20px;
        }
        
        #qr-reader {
            width: 100%;
            height: 300px;
            border: 3px solid #3498db;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 auto 15px auto;
            position: relative;
            background: #000;
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
        
        #qr-reader.active {
            display: block;
        }
        
        #qr-reader video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #qr-reader canvas {
            display: none;
        }
        
        .scanner-placeholder {
            width: 100%;
            height: 300px;
            border: 3px dashed #3498db;
            border-radius: 12px;
            margin: 0 auto 15px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .scanner-placeholder:hover {
            background: #e3f2fd;
            border-color: #2980b9;
        }
        
        .scanner-placeholder-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #3498db;
        }
        
        .scanner-placeholder-text {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .scanner-placeholder-hint {
            font-size: 14px;
            color: #666;
            text-align: center;
            max-width: 80%;
        }
        
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            border: 3px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        
        .scanner-instructions {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .scanner-instructions p {
            margin: 5px 0;
        }
        
        /* –ö–ù–û–ü–ö–ò –°–ö–ê–ù–ï–†–ê */
        .scanner-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-scan {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            transition: all 0.3s;
        }
        
        .btn-scan:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-scan:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-scan-stop {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-scan-stop:hover {
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        /* –†–£–ß–ù–û–ô –í–í–û–î */
        .manual-auth-section {
            border-top: 1px solid #e9ecef;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .manual-auth-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .manual-input {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        
        #employeeCode {
            flex: 1;
            min-width: 0;
            font-size: 16px;
            height: 46px;
            padding: 0 15px;
            border: 2px solid #3498db;
            border-radius: 8px;
            text-align: center;
        }
        
        #employeeCode:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn-auth {
            min-width: 90px;
            padding: 0 20px;
            height: 46px;
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        /* –°–¢–ê–¢–£–° –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò */
        .auth-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            min-height: 20px;
            text-align: center;
        }
        
        .auth-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .auth-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .auth-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .auth-status.scanning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* –î–ï–ú–û-–ö–û–î–´ */
        .demo-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            margin-top: 20px;
        }
        
        .demo-info h4 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .demo-codes {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .demo-code {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            flex: 1;
            max-width: 150px;
        }
        
        .demo-code:hover {
            background: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-2px);
        }
        
        /* –ê–î–ê–ü–¢–ê–¶–ò–Ø –î–õ–Ø –ú–ê–õ–ï–ù–¨–ö–ò–• –≠–ö–†–ê–ù–û–í */
        @media (max-height: 700px) {
            #qr-reader, .scanner-placeholder {
                height: 250px;
            }
            
            .scanner-frame {
                width: 180px;
                height: 180px;
            }
        }
        
        @media (max-height: 600px) {
            .auth-container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.3em;
                margin: 5px 0 10px 0;
            }
            
            #qr-reader, .scanner-placeholder {
                height: 220px;
            }
            
            .scanner-frame {
                width: 160px;
                height: 160px;
            }
            
            .auth-card {
                padding: 15px;
            }
        }
        
        @media (max-width: 350px) {
            .manual-input {
                flex-direction: column;
            }
            
            .btn-auth {
                width: 100%;
            }
            
            .demo-codes {
                flex-direction: column;
                align-items: center;
            }
            
            .demo-code {
                max-width: 100%;
                width: 100%;
            }
            
            .scanner-controls {
                flex-direction: column;
            }
        }
        
        /* –ò–ù–î–ò–ö–ê–¢–û–† –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø */
        .scanning-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #3498db);
            background-size: 200% 100%;
            animation: scanning 2s linear infinite;
            z-index: 2;
        }
        
        @keyframes scanning {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        /* –ü–†–ï–õ–û–ê–î–ï–† –ö–ê–ú–ï–†–´ */
        .camera-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            color: white;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –†–ê–ó–†–ï–®–ï–ù–ò–ò –ö–ê–ú–ï–†–´ */
        .camera-permission-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            color: #856404;
            display: none;
        }
        
        .camera-permission-notice.show {
            display: block;
        }
        
        .permission-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="logonwnew.png" alt="NORD WHEEL" class="logo-image" onerror="this.style.display='none'">
                <span class="logo-text">NORD WHEEL</span>
            </div>
        </header>

        <main class="auth-container">
            <h1>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h1>
            
            <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –†–ê–ó–†–ï–®–ï–ù–ò–ò -->
            <div class="camera-permission-notice" id="cameraPermissionNotice">
                <div class="permission-icon">üì±</div>
                <p><strong>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</strong></p>
                <p>–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä" –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞–º–µ—Ä—ã</p>
            </div>
            
            <div class="auth-card">
                <!-- QR-–°–ö–ê–ù–ï–† -->
                <div class="qr-scanner-section">
                    <!-- –ü–õ–ï–ô–°–•–û–õ–î–ï–† –î–õ–Ø –ó–ê–ü–£–°–ö–ê –°–ö–ê–ù–ï–†–ê -->
                    <div class="scanner-placeholder" id="scannerPlaceholder" onclick="startQRScanner()">
                        <div class="scanner-placeholder-icon">üì∑</div>
                        <div class="scanner-placeholder-text">–ó–∞–ø—É—Å—Ç–∏—Ç—å QR-—Å–∫–∞–Ω–µ—Ä</div>
                        <div class="scanner-placeholder-hint">
                            –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É –∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                        </div>
                    </div>
                    
                    <!-- –ê–ö–¢–ò–í–ù–´–ô –°–ö–ê–ù–ï–† (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div id="qr-reader">
                        <div class="scanner-frame"></div>
                        <div class="scanning-indicator"></div>
                        <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    
                    <div class="scanner-instructions" id="scannerInstructions">
                        <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
                        <p><small>–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ QR-–∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ –∑–µ–ª–µ–Ω–æ–π —Ä–∞–º–∫–∏</small></p>
                    </div>
                    
                    <!-- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ö–ê–ù–ï–†–û–ú -->
                    <div class="scanner-controls" id="scannerControls" style="display: none;">
                        <button id="stopScannerBtn" class="btn-scan btn-scan-stop" onclick="stopQRScanner()">
                            <span>‚èπÔ∏è</span> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä
                        </button>
                        <button id="switchCameraBtn" class="btn-scan" onclick="switchCamera()" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                            <span>üîÑ</span> –°–º–µ–Ω–∏—Ç—å –∫–∞–º–µ—Ä—É
                        </button>
                    </div>
                </div>

                <!-- –†–£–ß–ù–û–ô –í–í–û–î -->
                <div class="manual-auth-section">
                    <h3>–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é</h3>
                    <div class="manual-input">
                        <input type="text" 
                               id="employeeCode" 
                               placeholder="EMP001" 
                               maxlength="10"
                               pattern="[A-Z0-9]{6}"
                               inputmode="text"
                               autocapitalize="characters">
                        <button class="btn-auth" onclick="manualAuth()">–í–æ–π—Ç–∏</button>
                    </div>
                </div>

                <!-- –°–¢–ê–¢–£–° –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
                <div class="auth-status" id="authStatus">
                    –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å QR-—Å–∫–∞–Ω–µ—Ä" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
                </div>
            </div>

            <!-- –î–ï–ú–û-–ö–û–î–´ —É–¥–∞–ª–∏–ª —Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å –µ—Å—Ç—å EMP001 -->
            
        </main>
    </div>

    <script>
        // –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø QR-–°–ö–ê–ù–ï–†–ê
        let html5QrCode = null;
        let isScannerActive = false;
        let lastScannedCode = '';
        let currentCameraId = null;
        let camerasList = [];
        let currentCameraIndex = 0;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('NORD WHEEL Auth - Enhanced QR Scanner initialized');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–∞–º–µ—Ä—ã
            checkCameraSupport();
            
            // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                const input = document.getElementById('employeeCode');
                if (input) {
                    input.focus();
                }
            }, 500);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è
            checkExistingSession();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ –∫–∞–º–µ—Ä—ã
            showCameraPermissionNotice();
        });
        
        // –ü–û–ö–ê–ó–ê–¢–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –†–ê–ó–†–ï–®–ï–ù–ò–ò –ö–ê–ú–ï–†–´
        function showCameraPermissionNotice() {
            const notice = document.getElementById('cameraPermissionNotice');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥
            notice.classList.add('show');
            setTimeout(() => {
                notice.classList.remove('show');
            }, 5000);
        }
        
        // –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò –ö–ê–ú–ï–†–´
        function checkCameraSupport() {
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            
            if (!hasGetUserMedia) {
                showAuthStatus('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ', 'error');
                document.getElementById('scannerPlaceholder').style.opacity = '0.5';
                document.getElementById('scannerPlaceholder').style.cursor = 'not-allowed';
                document.getElementById('scannerPlaceholder').onclick = null;
                document.getElementById('scannerPlaceholder').innerHTML = `
                    <div class="scanner-placeholder-icon">üö´</div>
                    <div class="scanner-placeholder-text">–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</div>
                    <div class="scanner-placeholder-hint">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.
                    </div>
                `;
                return false;
            }
            
            return true;
        }
        
        // –ó–ê–ü–£–°–ö QR-–°–ö–ê–ù–ï–†–ê
        async function startQRScanner() {
            if (!checkCameraSupport()) {
                return;
            }
            
            if (isScannerActive) {
                return;
            }
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
                showAuthStatus('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...', 'loading');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
                document.getElementById('scannerPlaceholder').style.display = 'none';
                document.getElementById('qr-reader').classList.add('active');
                document.getElementById('scannerControls').style.display = 'flex';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –≤ —Å–∫–∞–Ω–µ—Ä
                const qrReader = document.getElementById('qr-reader');
                qrReader.innerHTML = `
                    <div class="camera-loader">
                        <div class="loader-spinner"></div>
                        <div>–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</div>
                        <div style="font-size: 12px; margin-top: 10px;">–ú–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ</div>
                    </div>
                    <div class="scanner-frame"></div>
                    <div class="scanning-indicator"></div>
                `;
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–º–µ—Ä
                camerasList = await Html5Qrcode.getCameras();
                console.log('Available cameras:', camerasList);
                
                if (camerasList && camerasList.length > 0) {
                    // –ò—â–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—É—é)
                    let selectedCameraIndex = 0;
                    for (let i = 0; i < camerasList.length; i++) {
                        const camera = camerasList[i];
                        if (camera.label.toLowerCase().includes('back') || 
                            camera.label.toLowerCase().includes('rear') ||
                            camera.label.toLowerCase().includes('environment')) {
                            selectedCameraIndex = i;
                            break;
                        }
                    }
                    
                    currentCameraIndex = selectedCameraIndex;
                    currentCameraId = camerasList[currentCameraIndex].id;
                    
                    showAuthStatus('–ö–∞–º–µ—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞. –ù–∞—á–∏–Ω–∞—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...', 'loading');
                    
                    // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫–∞–Ω–µ—Ä–∞
                    setTimeout(() => {
                        startCameraWithId(currentCameraId);
                    }, 500);
                    
                } else {
                    // –ï—Å–ª–∏ –∫–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —á–µ—Ä–µ–∑ API, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –º–µ—Ç–æ–¥
                    showAuthStatus('–ò—Å–ø–æ–ª—å–∑—É—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–∞–º–µ—Ä—É...', 'loading');
                    setTimeout(() => {
                        startCameraWithEnvironment();
                    }, 500);
                }
                
            } catch (error) {
                console.error('Scanner initialization error:', error);
                handleScannerError(error);
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                resetScannerUI();
            }
        }
        
        // –ó–ê–ü–£–°–ö –ö–ê–ú–ï–†–´ –° –ö–û–ù–ö–†–ï–¢–ù–´–ú ID
        async function startCameraWithId(cameraId) {
            try {
                // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–∫–∞–Ω–µ—Ä–∞
                html5QrCode = new Html5Qrcode("qr-reader");
                
                const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                    handleQRScanSuccess(decodedText);
                };
                
                const qrCodeErrorCallback = (error) => {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
                };
                
                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
                const config = {
                    fps: 10,
                    qrbox: {
                        width: 220,
                        height: 220
                    },
                    aspectRatio: 1.0,
                    disableFlip: false
                };
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä
                await html5QrCode.start(
                    cameraId,
                    config,
                    qrCodeSuccessCallback,
                    qrCodeErrorCallback
                );
                
                // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
                const cameraLoader = document.querySelector('.camera-loader');
                if (cameraLoader) {
                    cameraLoader.remove();
                }
                
                isScannerActive = true;
                showAuthStatus('–°–∫–∞–Ω–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥', 'scanning');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                document.getElementById('scannerInstructions').innerHTML = `
                    <p><strong>–°–∫–∞–Ω–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω!</strong></p>
                    <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
                    <p><small>–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ QR-–∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ –∑–µ–ª–µ–Ω–æ–π —Ä–∞–º–∫–∏</small></p>
                `;
                
            } catch (error) {
                console.error('Camera start error:', error);
                
                // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å environment mode
                if (error.message && error.message.includes('NotAllowedError')) {
                    showAuthStatus('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω', 'error');
                    setTimeout(() => {
                        showAuthStatus('–ü—Ä–æ–±—É—é –¥—Ä—É–≥–æ–π –º–µ—Ç–æ–¥...', 'loading');
                        startCameraWithEnvironment();
                    }, 2000);
                } else {
                    handleScannerError(error);
                    resetScannerUI();
                }
            }
        }
        
        // –ó–ê–ü–£–°–ö –ö–ê–ú–ï–†–´ –° environment MODE
        async function startCameraWithEnvironment() {
            try {
                // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–∫–∞–Ω–µ—Ä–∞
                html5QrCode = new Html5Qrcode("qr-reader");
                
                const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                    handleQRScanSuccess(decodedText);
                };
                
                const qrCodeErrorCallback = (error) => {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                };
                
                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
                const config = {
                    fps: 10,
                    qrbox: {
                        width: 220,
                        height: 220
                    },
                    aspectRatio: 1.0,
                    disableFlip: false
                };
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä —Å environment mode
                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    qrCodeSuccessCallback,
                    qrCodeErrorCallback
                );
                
                // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä
                const cameraLoader = document.querySelector('.camera-loader');
                if (cameraLoader) {
                    cameraLoader.remove();
                }
                
                isScannerActive = true;
                showAuthStatus('–°–∫–∞–Ω–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥', 'scanning');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                document.getElementById('scannerInstructions').innerHTML = `
                    <p><strong>–°–∫–∞–Ω–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω!</strong></p>
                    <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
                    <p><small>–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ QR-–∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ –∑–µ–ª–µ–Ω–æ–π —Ä–∞–º–∫–∏</small></p>
                `;
                
            } catch (error) {
                console.error('Environment camera error:', error);
                handleScannerError(error);
                resetScannerUI();
            }
        }
        
        // –°–ú–ï–ù–ê –ö–ê–ú–ï–†–´
        async function switchCamera() {
            if (!isScannerActive || !html5QrCode || camerasList.length < 2) {
                showAuthStatus('–¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                return;
            }
            
            try {
                showAuthStatus('–ü–µ—Ä–µ–∫–ª—é—á–∞—é –∫–∞–º–µ—Ä—É...', 'loading');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞–º–µ—Ä—É
                await html5QrCode.stop();
                
                // –í—ã–±–∏—Ä–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞–º–µ—Ä—É –≤ —Å–ø–∏—Å–∫–µ
                currentCameraIndex = (currentCameraIndex + 1) % camerasList.length;
                currentCameraId = camerasList[currentCameraIndex].id;
                
                showAuthStatus(`–ö–∞–º–µ—Ä–∞: ${camerasList[currentCameraIndex].label || '–ö–∞–º–µ—Ä–∞ ' + (currentCameraIndex + 1)}`, 'loading');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –∫–∞–º–µ—Ä—É
                await startCameraWithId(currentCameraId);
                
            } catch (error) {
                console.error('Camera switch error:', error);
                showAuthStatus('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –∫–∞–º–µ—Ä—ã', 'error');
            }
        }
        
        // –û–°–¢–ê–ù–û–í–ö–ê QR-–°–ö–ê–ù–ï–†–ê
        async function stopQRScanner() {
            if (!isScannerActive || !html5QrCode) {
                return;
            }
            
            try {
                showAuthStatus('–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–∫–∞–Ω–µ—Ä...', 'loading');
                
                await html5QrCode.stop();
                html5QrCode.clear();
                html5QrCode = null;
                isScannerActive = false;
                lastScannedCode = '';
                currentCameraId = null;
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º UI –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                resetScannerUI();
                
                showAuthStatus('–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'loading');
                setTimeout(() => {
                    showAuthStatus('–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å QR-—Å–∫–∞–Ω–µ—Ä" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã', '');
                }, 2000);
                
            } catch (error) {
                console.error('Error stopping scanner:', error);
                showAuthStatus('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞', 'error');
            }
        }
        
        // –°–ë–†–û–° –ò–ù–¢–ï–†–§–ï–ô–°–ê –°–ö–ê–ù–ï–†–ê
        function resetScannerUI() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
            document.getElementById('scannerPlaceholder').style.display = 'flex';
            document.getElementById('qr-reader').classList.remove('active');
            document.getElementById('scannerControls').style.display = 'none';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            document.getElementById('scannerInstructions').innerHTML = `
                <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
                <p><small>–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ QR-–∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ –∑–µ–ª–µ–Ω–æ–π —Ä–∞–º–∫–∏</small></p>
            `;
            
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∫–∞–Ω–µ—Ä–∞
            document.getElementById('qr-reader').innerHTML = `
                <div class="scanner-frame"></div>
                <div class="scanning-indicator"></div>
            `;
        }
        
        // –û–ë–†–ê–ë–û–¢–ö–ê –£–°–ü–ï–®–ù–û–ì–û –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø
        function handleQRScanSuccess(decodedText) {
            console.log('QR Code scanned:', decodedText);
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            if (decodedText === lastScannedCode) {
                return;
            }
            
            lastScannedCode = decodedText;
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const employeeCode = extractEmployeeCode(decodedText);
            
            if (employeeCode) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                showAuthStatus(`‚úÖ QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: ${employeeCode}`, 'success');
                
                // –ú–∏–≥–∞–Ω–∏–µ —Ä–∞–º–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
                const scannerFrame = document.querySelector('.scanner-frame');
                scannerFrame.style.borderColor = '#00ff00';
                scannerFrame.style.boxShadow = '0 0 0 1000px rgba(0, 255, 0, 0.2)';
                
                setTimeout(() => {
                    scannerFrame.style.borderColor = '#00ff00';
                    scannerFrame.style.boxShadow = '0 0 0 1000px rgba(0, 0, 0, 0.5)';
                }, 300);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    stopQRScanner();
                    
                    // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –µ—â–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        authenticateEmployee(employeeCode);
                    }, 1000);
                }, 1000);
                
            } else {
                // –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞
                showAuthStatus('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞', 'error');
                
                // –ú–∏–≥–∞–Ω–∏–µ —Ä–∞–º–∫–∏ –∫—Ä–∞—Å–Ω—ã–º
                const scannerFrame = document.querySelector('.scanner-frame');
                scannerFrame.style.borderColor = '#ff0000';
                scannerFrame.style.boxShadow = '0 0 0 1000px rgba(255, 0, 0, 0.2)';
                
                setTimeout(() => {
                    scannerFrame.style.borderColor = '#00ff00';
                    scannerFrame.style.boxShadow = '0 0 0 1000px rgba(0, 0, 0, 0.5)';
                }, 500);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞—â–∏—Ç—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    lastScannedCode = '';
                }, 3000);
            }
        }
        
        // –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ö–û–î–ê –ò–ó QR
        function extractEmployeeCode(qrData) {
            if (!qrData) return null;
            
            const cleanData = qrData.trim().toUpperCase();
            console.log('Analyzing QR data:', cleanData);
            
            // –í–∞—à –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ EMP00
            if (cleanData === 'EMP00') {
                console.log('Specific code EMP00 found');
                return 'EMP00';
            }
            
            // –ü—Ä—è–º–æ–π –∫–æ–¥ EMP001
            const directMatch = cleanData.match(/^EMP\d{2,3}$/);
            if (directMatch) {
                console.log('Direct code found:', directMatch[0]);
                return directMatch[0];
            }
            
            // –ö–æ–¥ –≤ —Ç–µ–∫—Å—Ç–µ
            const anywhereMatch = cleanData.match(/(EMP\d{2,3})/);
            if (anywhereMatch && anywhereMatch[1]) {
                console.log('Code found in text:', anywhereMatch[1]);
                return anywhereMatch[1];
            }
            
            console.log('No employee code found in QR data');
            return null;
        }
        
        // –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –°–ö–ê–ù–ï–†–ê
        function handleScannerError(error) {
            let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
            
            if (error.name === 'NotAllowedError' || error.message?.includes('NotAllowedError')) {
                errorMessage = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
            } else if (error.name === 'NotFoundError' || error.message?.includes('NotFoundError')) {
                errorMessage = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ';
            } else if (error.name === 'NotSupportedError' || error.message?.includes('NotSupportedError')) {
                errorMessage = '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ';
            } else if (error.name === 'NotReadableError' || error.message?.includes('NotReadableError')) {
                errorMessage = '–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º';
            } else if (error.message && error.message.includes('Permission denied')) {
                errorMessage = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
            }
            
            showAuthStatus(errorMessage, 'error');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é
            setTimeout(() => {
                showAuthStatus('1. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å" –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ<br>2. –ï—Å–ª–∏ –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞<br>3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑', 'error');
            }, 2000);
        }
        
        // –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
        // ... (manualAuth, useDemoCode, authenticateEmployee, showAuthStatus, checkExistingSession)
        
        // –†–£–ß–ù–ê–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
        function manualAuth() {
            const codeInput = document.getElementById('employeeCode');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showAuthStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 'error');
                codeInput.focus();
                return;
            }
            
            if (!code.match(/^EMP\d{2,3}$/)) {
                showAuthStatus('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞. –ü—Ä–∏–º–µ—Ä: EMP001', 'error');
                codeInput.focus();
                codeInput.select();
                return;
            }
            
            authenticateEmployee(code);
        }
        
        // –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –î–ï–ú–û-–ö–û–î–ê
        function useDemoCode(code) {
            const codeInput = document.getElementById('employeeCode');
            codeInput.value = code;
            codeInput.focus();
            showAuthStatus(`–î–µ–º–æ-–∫–æ–¥ "${code}" —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏"`, 'loading');
        }
        
        // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –°–û–¢–†–£–î–ù–ò–ö–ê
        function authenticateEmployee(employeeCode) {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
            if (isScannerActive) {
                stopQRScanner();
            }
            
            showAuthStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...', 'loading');
            
            setTimeout(() => {
                const employees = {
                    'EMP001': {
                        id: 'EMP001',
                        name: '–ò–≤–∞–Ω–æ–≤ –ê–ª–µ–∫—Å–µ–π',
                    },
                };
                
                const employee = employees[employeeCode];
                
                if (employee) {
                    employee.loginTime = new Date().toISOString();
                    employee.loginTimeDisplay = new Date().toLocaleString('ru-RU');
                    employee.sessionId = 'SESS_' + Date.now();
                    
                    localStorage.setItem('employeeAuth', JSON.stringify(employee));
                    
                    showAuthStatus(`‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${employee.name}`, 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'cargo.html';
                    }, 2000);
                    
                } else {
                    showAuthStatus('‚ùå –ö–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ', 'error');
                    const codeInput = document.getElementById('employeeCode');
                    if (codeInput) {
                        codeInput.focus();
                        codeInput.select();
                    }
                }
            }, 1000);
        }
        
        // –ü–û–ö–ê–ó–ê–¢–¨ –°–¢–ê–¢–£–° –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
        function showAuthStatus(message, type) {
            const statusElement = document.getElementById('authStatus');
            if (statusElement) {
                statusElement.innerHTML = message;
                statusElement.className = `auth-status ${type || ''}`;
                
                if (type === 'error' || type === 'success') {
                    setTimeout(() => {
                        if (statusElement.innerHTML === message) {
                            statusElement.innerHTML = '';
                            statusElement.className = 'auth-status';
                        }
                    }, type === 'error' ? 5000 : 3000);
                }
            }
        }
        
        // –ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –°–ï–°–°–ò–ò
        function checkExistingSession() {
            const authData = localStorage.getItem('employeeAuth');
            if (authData) {
                try {
                    const employee = JSON.parse(authData);
                    const loginTime = new Date(employee.loginTime);
                    const currentTime = new Date();
                    const hoursDiff = (currentTime - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 8) {
                        showAuthStatus(`–ê–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—Å–∏—è: ${employee.name}`, 'loading');
                        
                        setTimeout(() => {
                            const continueBtn = document.createElement('button');
                            continueBtn.className = 'btn-auth';
                            continueBtn.style.marginTop = '10px';
                            continueBtn.style.width = '100%';
                            continueBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É';
                            continueBtn.onclick = function() {
                                window.location.href = 'cargo.html';
                            };
                            
                            const statusElement = document.getElementById('authStatus');
                            statusElement.appendChild(document.createElement('br'));
                            statusElement.appendChild(continueBtn);
                        }, 500);
                    } else {
                        localStorage.removeItem('employeeAuth');
                    }
                } catch (e) {
                    localStorage.removeItem('employeeAuth');
                }
            }
        }
        
        // –û–°–¢–ê–ù–û–í–ö–ê –°–ö–ê–ù–ï–†–ê –ü–†–ò –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ï
        window.addEventListener('beforeunload', function() {
            if (isScannerActive) {
                stopQRScanner();
            }
        });
        
        // –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô
        window.manualAuth = manualAuth;
        window.useDemoCode = useDemoCode;
        window.startQRScanner = startQRScanner;
        window.stopQRScanner = stopQRScanner;
        window.switchCamera = switchCamera;
        
        console.log('NORD WHEEL Enhanced QR Scanner ready');
    </script>
</body>
</html>
