<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NORD WHEEL - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
        html, body {
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            padding: 0;
            margin: 0;
            border-radius: 0;
        }
        
        /* –®–ê–ü–ö–ê –° –õ–û–ì–û–¢–ò–ü–û–ú */
        header {
            background: #2c3e50;
            padding: 10px 15px !important;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-image {
            height: 28px;
            width: auto;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: bold;
            color: white;
        }
        
        .auth-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        h1 {
            margin: 10px 0 15px 0;
            color: #2c3e50;
            text-align: center;
            font-size: 1.5em;
        }
        
        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        /* QR-–°–ö–ê–ù–ï–† –°–¢–ò–õ–ò */
        .qr-scanner-section {
            margin-bottom: 20px;
        }
        
        #qr-reader {
            width: 100%;
            height: 250px;
            border: 2px solid #3498db;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 auto 15px auto;
            position: relative;
            background: #000;
        }
        
        #qr-reader video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #qr-reader canvas {
            display: none;
        }
        
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        
        .scanner-instructions {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .scanner-instructions p {
            margin: 5px 0;
        }
        
        /* –ö–ù–û–ü–ö–ê –ó–ê–ü–£–°–ö–ê –°–ö–ê–ù–ï–†–ê */
        .btn-scan {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .btn-scan:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-scan:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* –†–£–ß–ù–û–ô –í–í–û–î */
        .manual-auth-section {
            border-top: 1px solid #e9ecef;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .manual-auth-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .manual-input {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        
        #employeeCode {
            flex: 1;
            min-width: 0;
            font-size: 16px;
            height: 46px;
            padding: 0 15px;
            border: 2px solid #3498db;
            border-radius: 8px;
            text-align: center;
        }
        
        #employeeCode:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn-auth {
            min-width: 90px;
            padding: 0 20px;
            height: 46px;
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        /* –°–¢–ê–¢–£–° –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò */
        .auth-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            min-height: 20px;
            text-align: center;
        }
        
        .auth-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .auth-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .auth-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* –î–ï–ú–û-–ö–û–î–´ */
        .demo-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            margin-top: 20px;
        }
        
        .demo-info h4 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .demo-codes {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .demo-code {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            flex: 1;
            max-width: 150px;
        }
        
        .demo-code:hover {
            background: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-2px);
        }
        
        /* –ê–î–ê–ü–¢–ê–¶–ò–Ø –î–õ–Ø –ú–ê–õ–ï–ù–¨–ö–ò–• –≠–ö–†–ê–ù–û–í */
        @media (max-height: 700px) {
            #qr-reader {
                height: 200px;
            }
            
            .scanner-frame {
                width: 180px;
                height: 180px;
            }
        }
        
        @media (max-height: 600px) {
            .auth-container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.3em;
                margin: 5px 0 10px 0;
            }
            
            #qr-reader {
                height: 180px;
            }
            
            .scanner-frame {
                width: 160px;
                height: 160px;
            }
            
            .auth-card {
                padding: 15px;
            }
        }
        
        @media (max-width: 350px) {
            .manual-input {
                flex-direction: column;
            }
            
            .btn-auth {
                width: 100%;
            }
            
            .demo-codes {
                flex-direction: column;
                align-items: center;
            }
            
            .demo-code {
                max-width: 100%;
                width: 100%;
            }
        }
        
        /* –ò–ù–î–ò–ö–ê–¢–û–† –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø */
        .scanning-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #3498db);
            background-size: 200% 100%;
            animation: scanning 2s linear infinite;
            z-index: 2;
        }
        
        @keyframes scanning {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="logonwnew.png" alt="NORD WHEEL" class="logo-image" onerror="this.style.display='none'">
                <span class="logo-text">NORD WHEEL</span>
            </div>
        </header>

        <main class="auth-container">
            <h1>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h1>
            
            <div class="auth-card">
                <!-- QR-–°–ö–ê–ù–ï–† -->
                <div class="qr-scanner-section">
                    <div id="qr-reader">
                        <!-- –°–∫–∞–Ω–µ—Ä –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∑–¥–µ—Å—å -->
                        <div class="scanner-frame"></div>
                        <div class="scanning-indicator" style="display: none;"></div>
                    </div>
                    
                    <div class="scanner-instructions">
                        <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
                        <p><small>–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ QR-–∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏</small></p>
                    </div>
                    
                    <button id="startScannerBtn" class="btn-scan">
                        <span>üîç</span> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä
                    </button>
                    <button id="stopScannerBtn" class="btn-scan" style="background: linear-gradient(135deg, #e74c3c, #c0392b); display: none;">
                        <span>‚èπÔ∏è</span> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä
                    </button>
                </div>

                <!-- –†–£–ß–ù–û–ô –í–í–û–î -->
                <div class="manual-auth-section">
                    <h3>–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥</h3>
                    <div class="manual-input">
                        <input type="text" 
                               id="employeeCode" 
                               placeholder="EMP001" 
                               maxlength="10"
                               pattern="[A-Z0-9]{6}"
                               inputmode="text"
                               autocapitalize="characters">
                        <button class="btn-auth" onclick="manualAuth()">–í–æ–π—Ç–∏</button>
                    </div>
                </div>

                <!-- –°–¢–ê–¢–£–° –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
                <div class="auth-status" id="authStatus">
                    –ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é
                </div>
            </div>

            <!-- –î–ï–ú–û-–ö–û–î–´ -->
            <div class="demo-info">
                <h4>–î–µ–º–æ-–∫–æ–¥—ã:</h4>
                <div class="demo-codes">
                    <div class="demo-code" onclick="useDemoCode('EMP001')">EMP001 - –ò–≤–∞–Ω–æ–≤</div>
                    <div class="demo-code" onclick="useDemoCode('EMP002')">EMP002 - –ü–µ—Ç—Ä–æ–≤</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø QR-–°–ö–ê–ù–ï–†–ê
        let html5QrCode = null;
        let isScannerActive = false;
        let lastScannedCode = '';
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('NORD WHEEL Auth - QR Scanner initialized');
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const startBtn = document.getElementById('startScannerBtn');
            const stopBtn = document.getElementById('stopScannerBtn');
            const qrReader = document.getElementById('qr-reader');
            const scanningIndicator = document.querySelector('.scanning-indicator');
            
            // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
            startBtn.addEventListener('click', function() {
                startQRScanner();
            });
            
            // –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞
            stopBtn.addEventListener('click', function() {
                stopQRScanner();
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–∞–º–µ—Ä—ã
            checkCameraSupport();
            
            // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                const input = document.getElementById('employeeCode');
                if (input) {
                    input.focus();
                }
            }, 500);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è
            checkExistingSession();
        });
        
        // –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò –ö–ê–ú–ï–†–´
        function checkCameraSupport() {
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            
            if (!hasGetUserMedia) {
                showAuthStatus('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ', 'error');
                document.getElementById('startScannerBtn').disabled = true;
                document.getElementById('startScannerBtn').innerHTML = '<span>üö´</span> –ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            }
            
            return hasGetUserMedia;
        }
        
        // –ó–ê–ü–£–°–ö QR-–°–ö–ê–ù–ï–†–ê
        async function startQRScanner() {
            if (!checkCameraSupport()) {
                return;
            }
            
            if (isScannerActive) {
                return;
            }
            
            try {
                showAuthStatus('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...', 'loading');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                document.getElementById('startScannerBtn').style.display = 'none';
                document.getElementById('stopScannerBtn').style.display = 'flex';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                document.querySelector('.scanning-indicator').style.display = 'block';
                
                // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–∫–∞–Ω–µ—Ä–∞
                html5QrCode = new Html5Qrcode("qr-reader");
                
                const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    handleQRScanSuccess(decodedText);
                };
                
                const qrCodeErrorCallback = (error) => {
                    // –û—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–æ–¥–∞)
                    console.log(`QR Code scan error: ${error}`);
                };
                
                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
                const config = {
                    fps: 10,
                    qrbox: {
                        width: 200,
                        height: 200
                    },
                    aspectRatio: 1.0,
                    disableFlip: false
                };
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –∏ –≤—ã–±–∏—Ä–∞–µ–º –∑–∞–¥–Ω—é—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
                const cameras = await Html5Qrcode.getCameras();
                let cameraId = null;
                
                if (cameras && cameras.length > 0) {
                    // –ò—â–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
                    const rearCamera = cameras.find(camera => 
                        camera.label.toLowerCase().includes('back') || 
                        camera.label.toLowerCase().includes('rear') ||
                        camera.label.toLowerCase().includes('environment')
                    );
                    
                    cameraId = rearCamera ? rearCamera.id : cameras[0].id;
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞–º–µ—Ä–æ–π
                    await html5QrCode.start(
                        cameraId,
                        config,
                        qrCodeSuccessCallback,
                        qrCodeErrorCallback
                    );
                } else {
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∫–∞–º–µ—Ä—ã
                    await html5QrCode.start(
                        { facingMode: "environment" },
                        config,
                        qrCodeSuccessCallback,
                        qrCodeErrorCallback
                    );
                }
                
                isScannerActive = true;
                showAuthStatus('–°–∫–∞–Ω–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥', 'success');
                
            } catch (error) {
                console.error('Scanner error:', error);
                handleScannerError(error);
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                document.getElementById('startScannerBtn').style.display = 'flex';
                document.getElementById('stopScannerBtn').style.display = 'none';
                document.querySelector('.scanning-indicator').style.display = 'none';
            }
        }
        
        // –û–°–¢–ê–ù–û–í–ö–ê QR-–°–ö–ê–ù–ï–†–ê
        function stopQRScanner() {
            if (!isScannerActive || !html5QrCode) {
                return;
            }
            
            html5QrCode.stop().then((ignore) => {
                // –£—Å–ø–µ—à–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
                html5QrCode.clear();
                html5QrCode = null;
                isScannerActive = false;
                lastScannedCode = '';
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                document.getElementById('startScannerBtn').style.display = 'flex';
                document.getElementById('stopScannerBtn').style.display = 'none';
                document.querySelector('.scanning-indicator').style.display = 'none';
                
                showAuthStatus('–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'loading');
                
            }).catch((error) => {
                console.error('Error stopping scanner:', error);
                showAuthStatus('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞', 'error');
            });
        }
        
        // –û–ë–†–ê–ë–û–¢–ö–ê –£–°–ü–ï–®–ù–û–ì–û –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø QR-–ö–û–î–ê
        function handleQRScanSuccess(decodedText) {
            console.log('QR Code scanned:', decodedText);
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≥–æ –∂–µ –∫–æ–¥–∞
            if (decodedText === lastScannedCode) {
                return;
            }
            
            lastScannedCode = decodedText;
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ QR-–∫–æ–¥–∞
            const employeeCode = extractEmployeeCode(decodedText);
            
            if (employeeCode) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                showAuthStatus(`QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: ${employeeCode}`, 'success');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä
                stopQRScanner();
                
                // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    authenticateEmployee(employeeCode);
                }, 1000);
                
            } else {
                // –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞
                showAuthStatus('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞', 'error');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞—â–∏—Ç—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    lastScannedCode = '';
                }, 3000);
            }
        }
        
        // –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ö–û–î–ê –°–û–¢–†–£–î–ù–ò–ö–ê –ò–ó QR-–ö–û–î–ê
        function extractEmployeeCode(qrData) {
            if (!qrData) return null;
            
            const cleanData = qrData.trim().toUpperCase();
            console.log('Analyzing QR data:', cleanData);
            
            // 1. –ü—Ä—è–º–æ–π –∫–æ–¥ EMP001
            const directMatch = cleanData.match(/^EMP\d{2,3}$/);
            if (directMatch) {
                console.log('Direct code found:', directMatch[0]);
                return directMatch[0];
            }
            
            // 2. –í–∞—à –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ EMP00
            if (cleanData === 'EMP00') {
                console.log('Specific code EMP00 found');
                return 'EMP00';
            }
            
            // 3. –ö–æ–¥ –≤ —Ç–µ–∫—Å—Ç–µ: "EMP001" –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
            const anywhereMatch = cleanData.match(/(EMP\d{2,3})/);
            if (anywhereMatch && anywhereMatch[1]) {
                console.log('Code found anywhere in text:', anywhereMatch[1]);
                return anywhereMatch[1];
            }
            
            // 4. JSON –¥–∞–Ω–Ω—ã–µ: {"emp_code": "EMP001"}
            try {
                const jsonData = JSON.parse(qrData);
                const code = jsonData.employee_code || jsonData.code || jsonData.emp_code ||
                    jsonData.emp || jsonData.id || jsonData.user_code;
                if (code && typeof code === 'string') {
                    const jsonMatch = code.toUpperCase().match(/(EMP\d{2,3})/);
                    if (jsonMatch && jsonMatch[1]) {
                        console.log('JSON code found:', jsonMatch[1]);
                        return jsonMatch[1];
                    }
                }
            } catch (e) {
                // –ù–µ JSON, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
            }
            
            console.log('No employee code found in QR data');
            return null;
        }
        
        // –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –°–ö–ê–ù–ï–†–ê
        function handleScannerError(error) {
            let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
            
            if (error.name === 'NotAllowedError') {
                errorMessage = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
            } else if (error.name === 'NotFoundError') {
                errorMessage = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ';
            } else if (error.name === 'NotSupportedError') {
                errorMessage = '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ';
            } else if (error.name === 'NotReadableError') {
                errorMessage = '–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º';
            } else if (error.message && error.message.includes('Permission denied')) {
                errorMessage = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
            }
            
            showAuthStatus(errorMessage, 'error');
        }
        
        // –ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –°–ï–°–°–ò–ò
        function checkExistingSession() {
            const authData = localStorage.getItem('employeeAuth');
            if (authData) {
                try {
                    const employee = JSON.parse(authData);
                    const loginTime = new Date(employee.loginTime);
                    const currentTime = new Date();
                    const hoursDiff = (currentTime - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 8) {
                        showAuthStatus(`–ê–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—Å–∏—è: ${employee.name}`, 'loading');
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
                        setTimeout(() => {
                            const continueBtn = document.createElement('button');
                            continueBtn.className = 'btn-auth';
                            continueBtn.style.marginTop = '10px';
                            continueBtn.style.width = '100%';
                            continueBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É';
                            continueBtn.onclick = function() {
                                window.location.href = 'cargo.html';
                            };
                            
                            const statusElement = document.getElementById('authStatus');
                            statusElement.appendChild(document.createElement('br'));
                            statusElement.appendChild(continueBtn);
                        }, 500);
                    } else {
                        // –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞
                        localStorage.removeItem('employeeAuth');
                    }
                } catch (e) {
                    localStorage.removeItem('employeeAuth');
                }
            }
        }
        
        // –†–£–ß–ù–ê–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
        function manualAuth() {
            const codeInput = document.getElementById('employeeCode');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showAuthStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 'error');
                codeInput.focus();
                return;
            }
            
            if (!code.match(/^EMP\d{2,3}$/)) {
                showAuthStatus('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞. –ü—Ä–∏–º–µ—Ä: EMP001', 'error');
                codeInput.focus();
                codeInput.select();
                return;
            }
            
            authenticateEmployee(code);
        }
        
        // –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –î–ï–ú–û-–ö–û–î–ê
        function useDemoCode(code) {
            const codeInput = document.getElementById('employeeCode');
            codeInput.value = code;
            codeInput.focus();
            showAuthStatus(`–î–µ–º–æ-–∫–æ–¥ "${code}" —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏"`, 'loading');
        }
        
        // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –°–û–¢–†–£–î–ù–ò–ö–ê
        function authenticateEmployee(employeeCode) {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
            if (isScannerActive) {
                stopQRScanner();
            }
            
            showAuthStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...', 'loading');
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
            setTimeout(() => {
                // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–≤—Ä–µ–º–µ–Ω–Ω–∞—è)
                const employees = {
                    'EMP001': {
                        id: 'EMP001',
                        name: '–ò–≤–∞–Ω–æ–≤ –ê–ª–µ–∫—Å–µ–π',
                        position: '–°—Ç–∞—Ä—à–∏–π –∫–ª–∞–¥–æ–≤—â–∏–∫',
                        department: '–°–∫–ª–∞–¥ ‚Ññ1'
                    },
                    'EMP002': {
                        id: 'EMP002',
                        name: '–ü–µ—Ç—Ä–æ–≤ –°–µ—Ä–≥–µ–π',
                        position: '–ö–ª–∞–¥–æ–≤—â–∏–∫',
                        department: '–°–∫–ª–∞–¥ ‚Ññ2'
                    },
                    'EMP00': {
                        id: 'EMP00',
                        name: '–¢–µ—Å—Ç–æ–≤—ã–π –°–æ—Ç—Ä—É–¥–Ω–∏–∫',
                        position: '–¢–µ—Å—Ç–µ—Ä',
                        department: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç–¥–µ–ª'
                    }
                };
                
                const employee = employees[employeeCode];
                
                if (employee) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    employee.loginTime = new Date().toISOString();
                    employee.loginTimeDisplay = new Date().toLocaleString('ru-RU');
                    employee.sessionId = 'SESS_' + Date.now();
                    
                    localStorage.setItem('employeeAuth', JSON.stringify(employee));
                    
                    showAuthStatus(`–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${employee.name}`, 'success');
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≥—Ä—É–∑–æ–≤ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        window.location.href = 'cargo.html';
                    }, 2000);
                    
                } else {
                    showAuthStatus('–ö–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ', 'error');
                    const codeInput = document.getElementById('employeeCode');
                    if (codeInput) {
                        codeInput.focus();
                        codeInput.select();
                    }
                }
            }, 1000);
        }
        
        // –ü–û–ö–ê–ó–ê–¢–¨ –°–¢–ê–¢–£–° –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
        function showAuthStatus(message, type) {
            const statusElement = document.getElementById('authStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `auth-status ${type || ''}`;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
                if (type === 'error' || type === 'success') {
                    setTimeout(() => {
                        if (statusElement.textContent === message) {
                            statusElement.textContent = '';
                            statusElement.className = 'auth-status';
                        }
                    }, type === 'error' ? 5000 : 3000);
                }
            }
        }
        
        // –û–°–¢–ê–ù–û–í–ö–ê –°–ö–ê–ù–ï–†–ê –ü–†–ò –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        window.addEventListener('beforeunload', function() {
            if (isScannerActive) {
                stopQRScanner();
            }
        });
        
        // –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô –î–õ–Ø HTML
        window.manualAuth = manualAuth;
        window.useDemoCode = useDemoCode;
        window.startQRScanner = startQRScanner;
        window.stopQRScanner = stopQRScanner;
        
        console.log('NORD WHEEL QR Scanner ready');
    </script>
</body>
</html>
